<!doctype html>
<html lang="pl">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Translator Studio Desktop</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <header class="topbar">
      <div>
        <h1>Translator Studio</h1>
        <p class="sub">Web desktop workflow parity with Tkinter</p>
      </div>
      <div class="topbar-right">
        <div class="support-links">
          <button id="support-link">Wesprzyj projekt</button>
          <button id="repo-link">Repo online</button>
        </div>
        <span id="ver"></span>
      </div>
    </header>

    <main class="layout">
      <section class="card setup-card">
        <h2>Pierwsze uruchomienie (wymagane)</h2>
        <p class="setup-note">
          Potrzebujesz: (1) Ollama + model do pracy lokalnej albo (2) poprawny API key i internet dla providerow online.
        </p>
        <p id="os-hint" class="setup-note"></p>
        <div class="setup-grid">
          <div>
            <h3>Windows (PowerShell)</h3>
            <pre id="setup-win"></pre>
          </div>
          <div>
            <h3>Linux</h3>
            <pre id="setup-linux"></pre>
          </div>
          <div>
            <h3>macOS</h3>
            <pre id="setup-macos"></pre>
          </div>
        </div>
        <div class="row actions">
          <button id="copy-setup-btn">Kopiuj instrukcje pierwszego uruchomienia</button>
        </div>
      </section>

      <section class="card">
        <h2>Projekt i profile</h2>
        <div class="grid compact">
          <label>Projekt
            <select id="project_select"></select>
          </label>
          <label>Tryb kroku
            <select id="mode">
              <option value="translate">translate</option>
              <option value="edit">edit</option>
            </select>
          </label>
          <label>Profil kroku
            <select id="profile_select"></select>
          </label>
          <label>Nowy profil (z biezacych ustawien)
            <input id="new_profile_name" type="text" placeholder="np. Moj profil" />
          </label>
          <label>Nazwa nowego projektu
            <input id="new_project_name" type="text" placeholder="np. Ksiazka 1" />
          </label>
          <label>EPUB zrodlowy nowego projektu
            <div class="with-btn">
              <input id="new_project_source" type="text" placeholder="C:\\...\\book.epub" />
              <button id="pick_new_project_source_btn">Wybierz</button>
            </div>
          </label>
        </div>
        <div class="row actions">
          <button id="refresh-projects-btn">Odswiez projekty</button>
          <button id="create-project-btn">Nowy projekt</button>
          <button id="save-project-btn">Zapisz projekt</button>
          <button id="delete-project-btn" class="danger">Usun projekt</button>
          <button id="save-profile-btn">Zapisz jako profil</button>
          <button id="apply-profile-btn">Wczytaj profil</button>
        </div>
        <div id="counts" class="status"></div>
        <div id="project_summary" class="status"></div>
      </section>

      <section class="card">
        <h2>Pliki i ustawienia runu</h2>
        <div class="grid">
          <label>Provider
            <select id="provider">
              <option value="ollama">ollama</option>
              <option value="google">google</option>
            </select>
          </label>
          <label>Model
            <select id="model">
              <option value="">-- wybierz model --</option>
            </select>
          </label>
          <label>Input EPUB
            <div class="with-btn">
              <input id="input_epub" type="text" />
              <button id="pick_input_epub_btn">Wybierz</button>
            </div>
          </label>
          <label>Output EPUB
            <div class="with-btn">
              <input id="output_epub" type="text" />
              <button id="pick_output_epub_btn">Wybierz</button>
            </div>
          </label>
          <label>Prompt
            <div class="with-btn">
              <input id="prompt" type="text" />
              <button id="pick_prompt_btn">Wybierz</button>
            </div>
          </label>
          <label>Glossary
            <div class="with-btn">
              <input id="glossary" type="text" />
              <button id="pick_glossary_btn">Wybierz</button>
            </div>
          </label>
          <label>Cache
            <div class="with-btn">
              <input id="cache" type="text" />
              <button id="pick_cache_btn">Wybierz</button>
            </div>
          </label>
          <label>Ollama host
            <input id="ollama_host" type="text" />
          </label>
          <label>Google API key
            <input id="google_api_key" type="password" />
          </label>
          <label>Source lang
            <input id="source_lang" type="text" />
          </label>
          <label>Target lang
            <input id="target_lang" type="text" />
          </label>
          <label>Timeout
            <input id="timeout" type="text" />
          </label>
          <label>Attempts
            <input id="attempts" type="text" />
          </label>
          <label>Backoff
            <input id="backoff" type="text" />
          </label>
          <label>Batch max segs
            <input id="batch_max_segs" type="text" />
          </label>
          <label>Batch max chars
            <input id="batch_max_chars" type="text" />
          </label>
          <label>Sleep
            <input id="sleep" type="text" />
          </label>
          <label>Temperature
            <input id="temperature" type="text" />
          </label>
          <label>num_ctx
            <input id="num_ctx" type="text" />
          </label>
          <label>num_predict
            <input id="num_predict" type="text" />
          </label>
          <label>Tags
            <input id="tags" type="text" />
          </label>
        </div>
        <div class="row checks">
          <label><input id="use_cache" type="checkbox" /> use cache</label>
          <label><input id="use_glossary" type="checkbox" /> use glossary</label>
        </div>
      </section>

      <section class="card">
        <h2>Uruchamianie i kolejka</h2>
        <div class="row actions">
          <button id="save-config-btn">Zapisz config</button>
          <button id="models-btn">Pobierz modele</button>
          <button id="start-btn" class="primary">Start kroku</button>
          <button id="validate-btn">Walidacja EPUB</button>
          <button id="stop-btn" class="danger">Stop</button>
        </div>
        <div class="row actions">
          <button id="queue-btn">Kolejkuj</button>
          <button id="run-next-btn">Uruchom nastepny</button>
          <button id="run-all-btn">Run all pending</button>
          <button id="stop-run-all-btn">Stop run-all</button>
        </div>
        <div id="status" class="status">Status: --</div>
        <div id="run_metrics" class="status">Metryki runu: brak</div>
        <p id="msg" class="msg"></p>
      </section>

      <section class="card">
        <h2>Ostatnie akcje (timeline projektu)</h2>
        <pre id="history" class="history"></pre>
      </section>

      <section class="card log-card">
        <h2>Log procesu</h2>
        <pre id="log" class="log"></pre>
      </section>
    </main>

    <script>
      (() => {
        try {
          const setup = {
            windows: [
              '# Ollama (lokalnie)',
              'winget install Ollama.Ollama',
              'ollama pull llama3.1:8b',
              '',
              '# API key (provider online, np. Google Gemini)',
              'setx GOOGLE_API_KEY "<TWOJ_KLUCZ>"',
            ],
            linux: [
              '# Ollama (lokalnie)',
              'curl -fsSL https://ollama.com/install.sh | sh',
              'ollama pull llama3.1:8b',
              '',
              '# API key (provider online, np. Google Gemini)',
              'export GOOGLE_API_KEY="<TWOJ_KLUCZ>"',
            ],
            macos: [
              '# Ollama (lokalnie)',
              'brew install ollama',
              'ollama pull llama3.1:8b',
              '',
              '# API key (provider online, np. Google Gemini)',
              'export GOOGLE_API_KEY="<TWOJ_KLUCZ>"',
            ],
          };
          const win = document.getElementById('setup-win');
          const lin = document.getElementById('setup-linux');
          const mac = document.getElementById('setup-macos');
          if (win && !win.textContent.trim()) win.textContent = setup.windows.join('\n');
          if (lin && !lin.textContent.trim()) lin.textContent = setup.linux.join('\n');
          if (mac && !mac.textContent.trim()) mac.textContent = setup.macos.join('\n');

          const openUrl = async (url) => {
            try {
              if (window.desktopApi && typeof window.desktopApi.openExternal === 'function') {
                await window.desktopApi.openExternal(url);
                return;
              }
            } catch {}
            window.open(url, '_blank', 'noopener,noreferrer');
          };
          const bindOnce = (id, handler) => {
            const el = document.getElementById(id);
            if (!el || el.dataset.fallbackBound === '1') return;
            el.dataset.fallbackBound = '1';
            el.addEventListener('click', handler);
          };
          bindOnce('support-link', () => openUrl('https://github.com/sponsors/piotrgrechuta-web'));
          bindOnce('repo-link', () => openUrl('https://github.com/piotrgrechuta-web/epu2pl'));
          bindOnce('copy-setup-btn', async () => {
            const text = [
              'Windows (PowerShell):', ...setup.windows, '', 'Linux:', ...setup.linux, '', 'macOS:', ...setup.macos,
            ].join('\n');
            try {
              await navigator.clipboard.writeText(text);
            } catch {}
          });
        } catch {}
      })();
    </script>
    <script src="app.js"></script>
  </body>
</html>
